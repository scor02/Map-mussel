<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mussel Genetics Map & Network</title>

  <!-- ================================
       STYLES
       ================================= -->
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent1: #7c5cff;
      --accent2: #26d07f;
      --accent3: #3fb4ff;
      --muted: #9aa7c7;
      color-scheme: dark;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #071026 0%, #071b2a 60%);
      font-family: Inter, ui-sans-serif, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .app {
      display: grid;
      grid-template-columns: 46% 54%;
      gap: 18px;
      height: 100vh;
      padding: 18px;
      box-sizing: border-box;
      align-items: stretch;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      padding: 14px;
      color: var(--muted);
      position: relative;
      overflow: hidden;
    }

    header h1 { margin: 0; font-size: 1.05rem; color: white; }
    header p { margin: 6px 0 0; font-size: 0.85rem; }

    #mapContainer {
      height: calc(100% - 62px);
      border-radius: 8px;
      margin-top: 12px;
      background: rgba(255,255,255,0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 0.9rem;
      position: relative;
    }

    /* Fade-in animation for map iframe */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    .fade-in {
      animation: fadeIn 1s ease forwards;
    }

    /* Optional loading text */
    #mapLoading {
      position: absolute;
      color: var(--muted);
      font-size: 0.9rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    #network {
      height: calc(100% - 62px);
      border-radius: 8px;
      margin-top: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }

    .topbar {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 8px 10px;
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover { border-color: var(--accent3); color: white; }
    .btn.primary {
      background: linear-gradient(90deg, var(--accent1), var(--accent3));
      border: none;
      color: white;
    }

    .hint { font-size: 12px; color: var(--muted); }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; grid-auto-rows: 50vh; }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- ========== MAP PANEL ========== -->
    <div class="card" id="mapCard">
      <div class="topbar">
        <div style="flex:1">
          <h1>Mussel Sampling Map</h1>
          <p>Your R Leaflet map will appear here with a smooth fade-in effect.</p>
        </div>
        <div class="controls">
          <button class="btn primary" id="showNetworkBtn">Show Genetic Network</button>
        </div>
      </div>
      <div id="mapContainer">
        <span id="mapLoading">Map will load when you first open this panel...</span>
      </div>
    </div>

    <!-- ========== NETWORK PANEL ========== -->
    <div class="card" id="networkCard">
      <div class="topbar">
        <div style="flex:1">
          <h1>Genetic Similarity Network</h1>
          <p>Interactive D3 network of mussel relationships.</p>
        </div>
        <div class="controls">
          <button class="btn" id="showMapBtn">Show Map</button>
          <label class="hint">Similarity threshold</label>
          <input id="simThreshold" type="range" min="0" max="1" step="0.01" value="0.35" />
        </div>
      </div>
      <div id="network"></div>
    </div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script>
  /**************************************************************
   * SECTION 1: Lazy-load the R Leaflet map with fade animation
   **************************************************************/
  let mapLoaded = false;
  function loadMapIframe() {
    if (!mapLoaded) {
      const container = document.getElementById('mapContainer');
      container.innerHTML = '<div id="mapLoading">Loading map...</div>';

      // Create iframe for your R map
      const iframe = document.createElement('iframe');
      iframe.src = 'map/index.html';
      iframe.id = 'rmap';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.style.opacity = '0'; // start hidden

      // When the map finishes loading, fade it in
      iframe.addEventListener('load', () => {
        document.getElementById('mapLoading').remove();
        iframe.classList.add('fade-in');
      });

      container.appendChild(iframe);
      mapLoaded = true;
      console.log('‚úÖ R Leaflet map loaded with fade-in animation.');
    }
  }

  /**************************************************************
   * SECTION 2: Toggle panels (Map <-> Network)
   **************************************************************/
  const mapCard = document.getElementById('mapCard');
  const networkCard = document.getElementById('networkCard');

  document.getElementById('showMapBtn').addEventListener('click', () => {
    networkCard.style.display = 'none';
    mapCard.style.display = 'block';
    loadMapIframe(); // lazy-load map only once
  });

  document.getElementById('showNetworkBtn').addEventListener('click', () => {
    mapCard.style.display = 'none';
    networkCard.style.display = 'block';
  });

  mapCard.style.display = 'none';
  networkCard.style.display = 'block';

  /**************************************************************
   * SECTION 3: Generate example D3 network (you can replace this)
   **************************************************************/
  const samples = Array.from({length: 15}, (_, i) => ({
    id: `MSL_${String(i+1).padStart(3,'0')}`,
    species: ["Mytilus edulis", "Mytilus galloprovincialis", "Mytilus trossulus"][i%3]
  }));

  const distanceMatrix = samples.map(() =>
    samples.map(() => +(Math.random().toFixed(2)))
  );

  const graph = (() => {
    const n = samples.length;
    const nodes = samples.map(s => ({id:s.id, species:s.species}));
    const links = [];
    for (let i=0; i<n; i++) {
      for (let j=i+1; j<n; j++) {
        const d = distanceMatrix[i][j];
        const similarity = 1 - d;
        if (similarity > 0.35)
          links.push({source:samples[i].id, target:samples[j].id, similarity});
      }
    }
    return {nodes, links};
  })();

  const svg = d3.select("#network").append("svg")
    .attr("width", "100%")
    .attr("height", "100%");

  const gLinks = svg.append("g");
  const gNodes = svg.append("g");

  const width = document.getElementById('network').clientWidth;
  const height = document.getElementById('network').clientHeight;

  const simulation = d3.forceSimulation(graph.nodes)
    .force("link", d3.forceLink(graph.links).id(d => d.id).distance(d => 120*(1-d.similarity)))
    .force("charge", d3.forceManyBody().strength(-160))
    .force("center", d3.forceCenter(width/2, height/2));

  const link = gLinks.selectAll("line")
    .data(graph.links)
    .enter().append("line")
    .attr("stroke", d => d3.interpolateCool(d.similarity))
    .attr("stroke-width", d => 1 + d.similarity*4)
    .attr("stroke-opacity", 0.7);

  const node = gNodes.selectAll("circle")
    .data(graph.nodes)
    .enter().append("circle")
    .attr("r", 8)
    .attr("fill", d => d.species.includes("gallo") ? "#26d07f" :
                      d.species.includes("tross") ? "#7c5cff" : "#3fb4ff")
    .attr("stroke", "white")
    .attr("stroke-width", 1)
    .call(drag(simulation));

  node.append("title").text(d => `${d.species} (${d.id})`);

  node.on("click", (e, d) => {
    console.log(`Node clicked: ${d.id} (${d.species})`);
    focusOnSample(d.id, d.species);
  });

  simulation.on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);
    node
      .attr("cx", d => d.x)
      .attr("cy", d => d.y);
  });

  function drag(sim) {
    function dragstarted(e) { if (!e.active) sim.alphaTarget(0.3).restart(); e.subject.fx = e.subject.x; e.subject.fy = e.subject.y; }
    function dragged(e) { e.subject.fx = e.x; e.subject.fy = e.y; }
    function dragended(e) { if (!e.active) sim.alphaTarget(0); e.subject.fx = null; e.subject.fy = null; }
    return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
  }

  /**************************************************************
   * SECTION 4: Future Map Linking Stub
   **************************************************************/
  function focusOnSample(sampleId, species) {
    console.log(`üîç Focus requested for Sample ID: ${sampleId}, Species: ${species}`);
    // Later you can communicate with your R map:
    // const iframe = document.getElementById('rmap').contentWindow;
    // iframe.postMessage({ type: 'focusSample', sampleId, species }, '*');
  }

  window.focusOnSample = focusOnSample;
  </script>
</body>
</html>
